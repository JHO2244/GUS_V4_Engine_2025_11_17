name: GUS CI Spine v0.2

# ------------------------------------------------------------
# AUTHORITY DECLARATION (GDVS)
#
# This workflow is NON-AUTHORITATIVE.
# It MUST NOT encode security, integrity, or sealing logic.
#
# Authoritative sources:
#   - scripts/verify_repo_seals.py
#   - scripts/seal_snapshot.py
#   - scripts/verify_epoch_anchor.py
#   - scripts/verify_anchor.py
#
# CI is a transport + invocation layer ONLY.
# Any rule change MUST occur in the scripts, not here.
# ------------------------------------------------------------

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  integrity:
    runs-on: ubuntu-latest
    env:
      GUS_CI: "1"

    steps:
      - name: Checkout (PR head or push SHA)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"

      - name: Install CI dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install cryptography pytest
          if [ -f requirements.txt ]; then
            python -m pip install -r requirements.txt
          else
            echo "No requirements.txt found; skipping."
          fi

      - name: Verify HEAD seal (authoritative script)
        run: |
          python -m scripts.verify_repo_seals --head --require-head --no-sig --ci

      - name: Verify latest epoch anchor (authoritative script)
        run: |
          python -m scripts.verify_anchor

      - name: Run Tests
        run: |
          python -m pytest -q
